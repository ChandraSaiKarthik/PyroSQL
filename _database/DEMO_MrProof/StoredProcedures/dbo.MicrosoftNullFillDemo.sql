SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
CREATE   PROCEDURE dbo.MicrosoftNullFillDemo 
AS

declare @t table(
    ExecutionInstanceID uniqueidentifier,
    MachineID char(1),
    CaptureDate datetime,
    OutputValue Decimal(15,2)
)
  
INSERT @t
VALUES
('934C75E6-FC26-47F6-A18C-806890F2980F','A','20180120 10:20',NULL),
('934C75E6-FC26-47F6-A18C-806890F2980F','A','20180120 11:48',NULL),
('934C75E6-FC26-47F6-A18C-806890F2980F','A','20180120 12:08',30),
('934C75E6-FC26-47F6-A18C-806890F2980F','A','20180120 14:50',115),
('934C75E6-FC26-47F6-A18C-806890F2980F','A','20180120 16:20',76),
('934C75E6-FC26-47F6-A18C-806890F2980F','A','20180120 18:02',68),
('934C75E6-FC26-47F6-A18C-806890F2980F','A','20180120 20:10',NULL),
('934C75E6-FC26-47F6-A18C-806890F2980F','A','20180120 22:04',NULL),
  
 ('CCD50F31-733D-4F02-A520-FF4FBE4BD073','A','20180213 22:20',NULL),
('CCD50F31-733D-4F02-A520-FF4FBE4BD073','A','20180213 23:55',NULL),
('CCD50F31-733D-4F02-A520-FF4FBE4BD073','A','20180214 00:48',150),
('CCD50F31-733D-4F02-A520-FF4FBE4BD073','A','20180214 14:30',NULL),
('CCD50F31-733D-4F02-A520-FF4FBE4BD073','A','20180214 19:55',345),
('CCD50F31-733D-4F02-A520-FF4FBE4BD073','A','20180215 03:12',227),
('CCD50F31-733D-4F02-A520-FF4FBE4BD073','A','20180215 12:08',NULL),
  
('8C7894AD-7D14-44F6-BE99-7720C5A7C638','B','20180311 16:44',NULL),
('8C7894AD-7D14-44F6-BE99-7720C5A7C638','B','20180311 20:19',NULL),
('8C7894AD-7D14-44F6-BE99-7720C5A7C638','B','20180311 22:43',NULL),
('8C7894AD-7D14-44F6-BE99-7720C5A7C638','B','20180312 07:13',380),
('8C7894AD-7D14-44F6-BE99-7720C5A7C638','B','20180312 09:35',446),
('8C7894AD-7D14-44F6-BE99-7720C5A7C638','B','20180312 11:45',135),
('8C7894AD-7D14-44F6-BE99-7720C5A7C638','B','20180313 00:10',324),
('8C7894AD-7D14-44F6-BE99-7720C5A7C638','B','20180313 02:23',NULL),
  
 ('35542D14-2E3A-4CF1-86D9-00CF0433EB85','C','20180125 10:20',NULL),
('35542D14-2E3A-4CF1-86D9-00CF0433EB85','C','20180125 11:32',224),
('35542D14-2E3A-4CF1-86D9-00CF0433EB85','C','20180125 12:43',NULL),
('35542D14-2E3A-4CF1-86D9-00CF0433EB85','C','20180125 13:34',115),
('35542D14-2E3A-4CF1-86D9-00CF0433EB85','C','20180125 14:55',NULL),
('35542D14-2E3A-4CF1-86D9-00CF0433EB85','C','20180125 16:32',213),
('35542D14-2E3A-4CF1-86D9-00CF0433EB85','C','20180125 18:42',304),
('35542D14-2E3A-4CF1-86D9-00CF0433EB85','C','20180125 23:24',NULL)



SELECT * FROM @t

SELECT *,
    FIRST_VALUE(CaptureDate)
        OVER (
        PARTITION BY ExecutionInstanceID,MachineID
        ORDER BY CaptureDate ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS ExecutionInstanceStart,
    LAST_VALUE(CaptureDate)
        OVER (
        PARTITION BY ExecutionInstanceID,MachineID
        ORDER BY CaptureDate ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS ExecutionInstanceEnd,
    FIRST_VALUE(OutputValue)
        OVER (PARTITION BY ExecutionInstanceID,MachineID
        ORDER BY CaptureDate  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS FirstValue,
    LAST_VALUE(OutputValue)
        OVER (PARTITION BY ExecutionInstanceID,MachineID
        ORDER BY CaptureDate RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS LastValue
FROM @t



SELECT ExecutionInstanceID,
MachineID,
CaptureDate,
OutputValue,
ExecutionInstanceStart,
ExecutionInstanceEnd,
MIN(CASE WHEN ValuesBefore = 1 THEN OutputValue END) OVER (PARTITION BY ExecutionInstanceID,
MachineID) AS FirstReading,
MAX(CASE WHEN ValuesAhead = 1 THEN OutputValue END) OVER (PARTITION BY ExecutionInstanceID,
MachineID)  AS LastReading
FROM
(
SELECT *,
FIRST_VALUE(CaptureDate) OVER (PARTITION BY ExecutionInstanceID,
MachineID
ORDER BY CaptureDate  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS ExecutionInstanceStart,
LAST_VALUE(CaptureDate) OVER (PARTITION BY ExecutionInstanceID,
MachineID
ORDER BY CaptureDate  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS ExecutionInstanceEnd,
FIRST_VALUE(OutputValue) OVER (PARTITION BY ExecutionInstanceID,
MachineID
ORDER BY CaptureDate  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS FirstValue,
LAST_VALUE(OutputValue) OVER (PARTITION BY ExecutionInstanceID,
MachineID
ORDER BY CaptureDate ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS LastValue,
COUNT(CASE WHEN OutputValue IS NOT NULL THEN OutputValue END) OVER (PARTITION BY ExecutionInstanceID,
MachineID
ORDER BY CaptureDate  ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS ValuesAhead,
COUNT(CASE WHEN OutputValue IS NOT NULL THEN OutputValue END) OVER (PARTITION BY ExecutionInstanceID,
MachineID
ORDER BY CaptureDate   ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ) AS ValuesBefore
FROM @t
)t
GO
